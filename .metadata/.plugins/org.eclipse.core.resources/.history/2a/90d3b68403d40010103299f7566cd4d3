package com.tms.tms_backend.controller;

import com.tms.tms_backend.dto.BidScoreDTO;
import com.tms.tms_backend.entity.Load;
import com.tms.tms_backend.enums.LoadStatusType;
import com.tms.tms_backend.service.LoadService;
import org.springframework.data.domain.Pageable;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.server.ResponseStatusException;

import java.util.List;
import java.util.UUID;

@RestController
@RequestMapping("/load")
public class LoadController {

    private final LoadService loadService;

    public LoadController(LoadService loadService) {
        this.loadService = loadService;
    }


    @PostMapping
    public ResponseEntity<Load> createLoad(@RequestBody Load load) {


//        if (load.getRemainingTrucks() == null || load.getRemainingTrucks() < 1) {
//            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, "Remaining trucks (initial requirement) must be specified and positive.");
//        }


        load.setStatus(LoadStatusType.POSTED);

        Load savedLoad = loadService.saveLoad(load);
        return new ResponseEntity<>(savedLoad, HttpStatus.CREATED);
    }


    @GetMapping
    public ResponseEntity<List<Load>> listLoads(
            @RequestParam(required = false) String shipperId,
            @RequestParam(required = false) LoadStatusType status,
            Pageable pageable) {

        // Fetches loads based on filter criteria
        List<Load> loads = loadService.findAllLoads(shipperId, status);
        return ResponseEntity.ok(loads);
    }


    @GetMapping("/{loadId}")
    public ResponseEntity<Load> getLoadDetails(@PathVariable UUID loadId) {
        Load load = loadService.findLoadById(loadId)
                .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND, "Load not found with ID: " + loadId));
        return ResponseEntity.ok(load);
    }


    @PatchMapping("/{loadId}/cancel")
    public ResponseEntity<Void> cancelLoad(@PathVariable UUID loadId) {
        loadService.cancelLoad(loadId); // Transactional logic handles cancellations
        return ResponseEntity.noContent().build();
    }


    @GetMapping("/{loadId}/best-bids")
    public ResponseEntity<List<BidScoreDTO>> getBestBids(@PathVariable UUID loadId) {
        List<BidScoreDTO> bestBids = loadService.getBestBids(loadId);
        return ResponseEntity.ok(bestBids);
    }
}